Vercel 배포 계획 수립을 위해 현재 상태 확인 중.


[5 tools called]


Vercel 배포 계획 수립 중. 기존 문서와 현재 상태를 반영합니다.


[3 tools called]


Vercel 배포 계획 수립 중. 현재 상태를 반영합니다.

## Vercel 배포 계획

### Phase 0: 배포 전 준비 (현재)

#### 1. 코드 검증 완료
- [x] Flask 엔드포인트: `/shipments/verify` 구현
- [x] OpenAPI 스키마: `/shipments/verify` 경로 추가
- [x] 테스트: `test_shipments_verify.py` 8/8 통과
- [x] 문법 오류: 수정 완료

#### 2. OpenAPI 스키마 URL 통일 필요

현재 상태:
- 루트 `openapi-schema.yaml`: `gets-416ut4t8g-chas-projects-08028e73.vercel.app`
- `docs/openapi/openapi-gets-api.yaml`: `gets-416ut4t8g-chas-projects-08028e73.vercel.app`
- `docs/openapi/openapi-schema.yaml`: `gets-logistics-api.vercel.app`
- README.md: `gets-logistics-api.vercel.app`

조치: Production URL을 `https://gets-logistics-api.vercel.app`로 통일

#### 3. 문서 업데이트 필요
- [ ] README.md: API Endpoints 테이블 업데이트
- [ ] README.md: "All 9 endpoints" → "All 10 endpoints"
- [ ] VERCEL_DEPLOYMENT_GUIDE.md: 엔드포인트 목록 업데이트

---

### Phase 1: 배포 전 검증 (5-10분)

#### 1.1 로컬 테스트 실행

```bash
# 1. 테스트 실행
pytest tests/test_shipments_verify.py -v

# 2. 전체 테스트 실행
pytest tests/ -v

# 3. OpenAPI 스키마 동기화 확인
python scripts/sync_openapi.py
# 또는
./scripts/sync_openapi.sh
```

#### 1.2 OpenAPI 스키마 URL 통일

루트 `openapi-schema.yaml`과 `docs/openapi/openapi-gets-api.yaml`의 `servers.url`을 통일:

```yaml
servers:
  - url: https://gets-logistics-api.vercel.app
    description: Production server (Vercel Serverless)
```

#### 1.3 배포 Preflight 실행

```bash
# Production URL 설정
export PROD_URL="https://gets-logistics-api.vercel.app"

# Preflight 스크립트 실행
chmod +x scripts/deploy_preflight.sh
./scripts/deploy_preflight.sh
```

예상 결과:
```
DEPLOY PREFLIGHT PASSED
PROD_URL      : https://gets-logistics-api.vercel.app
Health        : OK
schemaVersion : 2025-12-25T00:32:52+0400
```

---

### Phase 2: Vercel 환경변수 설정 (5분)

#### 2.1 Vercel Dashboard 접속

1. https://vercel.com/dashboard 접속
2. 프로젝트 선택: `gets-api`
3. Settings → Environment Variables

#### 2.2 환경변수 확인/추가

필수 (이미 설정되어 있을 가능성 높음):
```
AIRTABLE_API_TOKEN = <your-airtable-pat>
```

새로 추가 (API_KEY 사용 시):
```
API_KEY = <your-optional-api-key>
```

설정 옵션:
- Environment: Production, Preview, Development 모두 체크
- Save 클릭

#### 2.3 환경변수 확인

```bash
# Vercel CLI로 확인 (선택)
vercel env ls
```

---

### Phase 3: 배포 실행 (2-5분)

#### 옵션 A: 자동 배포 (권장)

```bash
# 1. 변경사항 커밋
git add .
git commit -m "feat: add /shipments/verify endpoint for GPTs Actions"

# 2. GitHub에 푸시 (자동 배포 트리거)
git push origin main
```

Vercel이 자동으로:
- GitHub webhook 감지
- 빌드 시작
- 배포 실행
- 배포 완료 알림

#### 옵션 B: 수동 배포

```bash
# Vercel CLI 사용
vercel --prod
```

---

### Phase 4: 배포 후 검증 (5-10분)

#### 4.1 Health Check

```bash
PROD_URL="https://gets-logistics-api.vercel.app"

curl "${PROD_URL}/health" | python -m json.tool
```

예상 응답:
```json
{
  "status": "healthy",
  "version": "1.7.0",
  "airtable": {
    "configured": true,
    "connected": true
  },
  "lockedConfig": {
    "schemaVersion": "2025-12-25T00:32:52+0400"
  }
}
```

#### 4.2 `/shipments/verify` 엔드포인트 테스트

```bash
# 공개 모드 (API_KEY 미설정 시)
curl "${PROD_URL}/shipments/verify?shptNo=HE-0512,HE-0513" | python -m json.tool

# 인증 모드 (API_KEY 설정 시)
curl -H "X-API-Key: <your-key>" \
  "${PROD_URL}/shipments/verify?shptNo=HE-0512" | python -m json.tool
```

예상 응답:
```json
{
  "items": [
    {
      "shptNo": "HE-0512",
      "site": "MIR",
      "eta": "2025-12-18T00:00:00Z",
      "nextAction": "...",
      "riskLevel": "HIGH",
      "currentBottleneckCode": "INSPECT_RED"
    }
  ],
  "meta": {
    "count": 1,
    "duplicates": [],
    "timestamp": "2026-01-06T00:00:00+04:00",
    "schemaVersion": "2025-12-25T00:32:52+0400"
  }
}
```

#### 4.3 OpenAPI 스키마 확인

```bash
# 스키마 파일 서빙 확인
curl "${PROD_URL}/openapi-schema.yaml" | grep -A 5 "/shipments/verify"

# 또는 전체 스키마 다운로드
curl "${PROD_URL}/openapi-schema.yaml" -o /tmp/openapi-schema.yaml
```

#### 4.4 엔드포인트 목록 확인

```bash
curl "${PROD_URL}/" | python -m json.tool | grep -A 10 "endpoints"
```

`"shipments_verify": "/shipments/verify?shptNo=A,B,C"`가 포함되어야 합니다.

#### 4.5 Vercel Dashboard 확인

1. Deployments 탭:
   - 최신 배포 상태 확인
   - 빌드 로그 확인
   - Function Logs에서 오류 확인

2. Analytics 탭:
   - 트래픽 확인
   - 응답 시간 확인

---

### Phase 5: GPTs Actions 연결 (10-15분)

#### 5.1 OpenAPI 스키마 URL 확인

```
https://gets-logistics-api.vercel.app/openapi-schema.yaml
```

#### 5.2 ChatGPT Custom GPT 설정

1. ChatGPT → Custom GPT 편집
2. Actions → Create new action
3. Import from URL:
   ```
   https://gets-logistics-api.vercel.app/openapi-schema.yaml
   ```
4. 인증 설정 (API_KEY 사용 시):
   - Type: API Key
   - Header name: `X-API-Key`
   - Key: Vercel `API_KEY` 환경변수 값
5. Save

#### 5.3 GPTs 테스트

GPTs에서 테스트:
```
"Verify shipments HE-0512, HE-0513, SCT-0151"
```

예상 동작:
- GPTs가 `/shipments/verify?shptNo=HE-0512,HE-0513,SCT-0151` 호출
- 결과를 표 형식으로 표시
- 중복이 있으면 경고 표시

---

## 배포 체크리스트

### 배포 전 (Phase 0-1)

- [x] 코드 검증 완료
- [ ] OpenAPI 스키마 URL 통일 (`gets-logistics-api.vercel.app`)
- [ ] 문서 업데이트 (README.md, VERCEL_DEPLOYMENT_GUIDE.md)
- [ ] 로컬 테스트 실행
- [ ] 배포 Preflight 실행

### 배포 중 (Phase 2-3)

- [ ] Vercel 환경변수 확인/설정
  - [ ] `AIRTABLE_API_TOKEN` 확인
  - [ ] `API_KEY` 추가 (선택)
- [ ] 배포 실행 (GitHub push 또는 `vercel --prod`)

### 배포 후 (Phase 4-5)

- [ ] `/health` 엔드포인트 검증
- [ ] `/shipments/verify` 엔드포인트 검증
- [ ] OpenAPI 스키마 서빙 확인
- [ ] 엔드포인트 목록 확인
- [ ] Vercel Dashboard 로그 확인
- [ ] GPTs Actions 연결 및 테스트

---

## 예상 소요 시간

| Phase | 작업 | 소요 시간 |
|-------|------|----------|
| Phase 0 | 배포 전 준비 | 10-15분 |
| Phase 1 | 배포 전 검증 | 5-10분 |
| Phase 2 | 환경변수 설정 | 5분 |
| Phase 3 | 배포 실행 | 2-5분 (자동) / 1-2분 (수동) |
| Phase 4 | 배포 후 검증 | 5-10분 |
| Phase 5 | GPTs 연결 | 10-15분 |
| **총계** | | **37-60분** |

---

## 트러블슈팅 가이드

### 문제: 배포 실패 (FUNCTION_INVOCATION_FAILED)

원인: 코드 오류 또는 환경변수 누락

해결:
1. Vercel Dashboard → Deployments → 최신 배포 → Logs 확인
2. 로컬에서 `flask --app api.app run` 실행하여 오류 확인
3. 환경변수 확인: `vercel env ls`

### 문제: 503 Service Unavailable

원인: `AIRTABLE_API_TOKEN` 미설정 또는 잘못된 토큰

해결:
1. Vercel Dashboard → Environment Variables 확인
2. Airtable 토큰 재발급 필요 시: https://airtable.com/create/tokens
3. Redeploy 실행

### 문제: 401 Unauthorized

원인: `API_KEY` 설정되었지만 헤더 누락

해결:
- `X-API-Key: <key>` 헤더 추가
- 또는 `Authorization: Bearer <key>` 헤더 추가

### 문제: OpenAPI 스키마가 업데이트되지 않음

원인: `openapi-schema.yaml` 파일이 동기화되지 않음

해결:
```bash
# 동기화 스크립트 실행
python scripts/sync_openapi.py
# 또는
./scripts/sync_openapi.sh

# Git commit & push
git add openapi-schema.yaml
git commit -m "chore: sync openapi schema"
git push origin main
```

---

## 즉시 실행 가능한 명령어

### 1. 배포 전 검증 (한 번에 실행)

```bash
# 테스트 실행
pytest tests/test_shipments_verify.py -v

# OpenAPI 스키마 동기화
python scripts/sync_openapi.py

# Preflight 검증
export PROD_URL="https://gets-logistics-api.vercel.app"
./scripts/deploy_preflight.sh
```

### 2. 배포 실행

```bash
# 자동 배포 (GitHub push)
git add .
git commit -m "feat: add /shipments/verify endpoint"
git push origin main

# 또는 수동 배포
vercel --prod
```

### 3. 배포 후 검증 (한 번에 실행)

```bash
PROD_URL="https://gets-logistics-api.vercel.app"

# Health check
curl "${PROD_URL}/health" | python -m json.tool

# Shipments verify
curl "${PROD_URL}/shipments/verify?shptNo=HE-0512" | python -m json.tool

# OpenAPI 스키마 확인
curl "${PROD_URL}/openapi-schema.yaml" | grep -A 5 "/shipments/verify"
```

---

## 최종 확인 사항

### 배포 전 필수 확인

1. [ ] 모든 테스트 통과 (`pytest tests/ -v`)
2. [ ] OpenAPI 스키마 URL 통일 (`gets-logistics-api.vercel.app`)
3. [ ] `AIRTABLE_API_TOKEN` 환경변수 설정 확인
4. [ ] `API_KEY` 환경변수 추가 여부 결정
5. [ ] 배포 Preflight 통과

### 배포 후 필수 확인

1. [ ] `/health` 엔드포인트 정상 응답
2. [ ] `/shipments/verify` 엔드포인트 정상 응답
3. [ ] OpenAPI 스키마 서빙 확인
4. [ ] Vercel Dashboard 로그 오류 없음
5. [ ] GPTs Actions 연결 성공

---

배포 준비가 완료되었습니다. 위 순서대로 진행하세요. 문제가 발생하면 트러블슈팅 가이드를 참고하세요.
