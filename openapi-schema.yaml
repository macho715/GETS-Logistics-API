openapi: 3.1.0
info:
  title: GETS Logistics API
  version: 1.8.0
  description: |
    HVDC Project Logistics API (Phase 4.1 + Approval/Bottleneck Endpoints)

    Provides operational status packets for shipment document tracking,
    approval management, bottleneck analysis, and KPI monitoring.

    Features:
    - Offset paging (automatic pagination)
    - Rate limiting (5 rps per base)
    - Retry logic (429, 503)
    - Batch operations (≤10 records/req)
    - Upsert support (idempotent ingest)
    - rename-safe: fieldId-based parsing
    - D-5/D-15 SLA classification
    - Timezone normalization (Z/UTC support)

    Timezone: Asia/Dubai (+04:00)
    Data Source: Airtable (Real-time)
    Schema Version: 2025-12-25T00:32:52+0400

servers:
  - url: https://gets-416ut4t8g-chas-projects-08028e73.vercel.app
    description: Production server (Vercel) - Phase 4.1

paths:
  /approval/status/{shptNo}:
    get:
      summary: Get approval status for shipment
      operationId: getApprovalStatus
      description: Returns approval details with D-5/D-15 SLA analysis and priority classification.
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number (e.g., SCT-0143)
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Approval status retrieved (may have empty approvals array)
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  approvals:
                    type: array
                    items:
                      type: object
                      properties:
                        approvalKey:
                          type: string
                        approvalType:
                          type: string
                        status:
                          type: string
                        dueAt:
                          type: string
                        daysUntilDue:
                          type: number
                        priority:
                          type: string
                  summary:
                    type: object
                    properties:
                      total:
                        type: integer
                      pending:
                        type: integer
                      approved:
                        type: integer
                      critical:
                        type: integer
                  schemaVersion:
                    type: string
        '404':
          description: Shipment not found
        '503':
          description: Service unavailable

  /approval/summary:
    get:
      summary: Get global approval summary
      operationId: getApprovalSummary
      description: Returns statistics by type and SLA status (D-15/D-5/overdue) for all approvals.
      responses:
        '200':
          description: Approval summary retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: object
                    properties:
                      total:
                        type: integer
                      pending:
                        type: integer
                  byType:
                    type: object
                  critical:
                    type: object
                    properties:
                      overdue:
                        type: integer
                      d5:
                        type: integer
                      d15:
                        type: integer
        '503':
          description: Service unavailable

  /bottleneck/summary:
    get:
      summary: Get bottleneck analysis
      operationId: getBottleneckSummary
      description: Returns bottleneck statistics with aging distribution (24h/48h/72h+) and top-N list.
      responses:
        '200':
          description: Bottleneck summary retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  byCategory:
                    type: object
                  byCode:
                    type: object
                  aging:
                    type: object
                    properties:
                      under24h:
                        type: integer
                      under48h:
                        type: integer
                      under72h:
                        type: integer
                      over72h:
                        type: integer
                  topBottlenecks:
                    type: array
                    items:
                      type: object
                  totalActive:
                    type: integer
        '503':
          description: Service unavailable

  /document/events/{shptNo}:
    get:
      summary: Get event history for shipment
      operationId: getDocumentEvents
      description: Returns chronological event history (latest first) for document state transitions.
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number (e.g., SCT-0143)
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Events retrieved (may be empty array)
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        eventId:
                          type: integer
                        timestamp:
                          type: string
                        entityType:
                          type: string
                        fromStatus:
                          type: string
                        toStatus:
                          type: string
                  total:
                    type: integer
        '404':
          description: Shipment not found
        '503':
          description: Service unavailable

  /document/status/{shptNo}:
    get:
      summary: Get document status packet
      operationId: getDocumentStatus
      description: |
        Returns operational status packet for a shipment including:
        - Document status (BOE, DO, COO, HBL, CIPL)
        - Bottleneck analysis (code, since, risk level)
        - Next action (description, owner, due date)
        - Evidence references
        - Data lag metrics
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number (e.g., SCT-0143)
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  doc:
                    type: object
                    properties:
                      boeStatus:
                        type: string
                      doStatus:
                        type: string
                      cooStatus:
                        type: string
                      hblStatus:
                        type: string
                      ciplStatus:
                        type: string
                  bottleneck:
                    type: object
                    properties:
                      code:
                        type: string
                      since:
                        type: string
                      riskLevel:
                        type: string
                  action:
                    type: object
                    properties:
                      nextAction:
                        type: string
                      owner:
                        type: string
                      dueAt:
                        type: string
                  evidence:
                    type: array
                    items:
                      type: object
                  meta:
                    type: object
                    properties:
                      dataLagMinutes:
                        type: integer
                      lastUpdated:
                        type: string
              example:
                shptNo: "SCT-0143"
                doc:
                  boeStatus: "SUBMITTED"
                  doStatus: "NOT_STARTED"
                  cooStatus: "PENDING"
                  hblStatus: "READY"
                  ciplStatus: "VALID"
                bottleneck:
                  code: "FANR_PENDING"
                  since: "2025-12-24T09:00:00+04:00"
                  riskLevel: "HIGH"
                action:
                  nextAction: "FANR 승인 상태 확인 및 가속 요청"
                  owner: "Customs/Compliance"
                  dueAt: "2025-12-25T12:00:00+04:00"
                evidence: []
                meta:
                  dataLagMinutes: 900
                  lastUpdated: "2025-12-25T00:00:00+04:00"
        '404':
          description: Shipment not found

  /approval/status/{shptNo}:
    get:
      summary: Get approval status
      operationId: getApprovalStatus
      description: |
        Returns approval tracking information for a shipment including:
        - Approval type (FANR, MOEI, MOIAT, etc.)
        - Status (SUBMITTED, PENDING, APPROVED, etc.)
        - Timeline (submitted, due dates)
        - Owner information
        - Evidence references
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  approvals:
                    type: array
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                        status:
                          type: string
                        submittedAt:
                          type: string
                        dueAt:
                          type: string
                        owner:
                          type: string
                        evidenceIds:
                          type: array
                          items:
                            type: string
                  lastUpdated:
                    type: string

  /document/events/{shptNo}:
    get:
      summary: Get event history
      operationId: getDocumentEvents
      description: |
        Returns append-only event ledger for a shipment.
        Useful for audit trail and timeline analysis.
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        eventId:
                          type: integer
                        timestamp:
                          type: string
                        entityType:
                          type: string
                        fromStatus:
                          type: string
                        toStatus:
                          type: string
                        bottleneckCode:
                          type: string
                        actor:
                          type: string
                        sourceSystem:
                          type: string
                  totalEvents:
                    type: integer
                  lastUpdated:
                    type: string

  /status/summary:
    get:
      summary: Get overall KPI summary
      operationId: getStatusSummary
      description: |
        Returns aggregated KPI metrics including:
        - Total shipment count
        - Document completion rates
        - Risk distribution
        - Top bottlenecks
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataSource:
                    type: string
                  totalShipments:
                    type: integer
                  boeRate:
                    type: number
                  doRate:
                    type: number
                  cooRate:
                    type: number
                  hblRate:
                    type: number
                  ciplRate:
                    type: number
                  riskSummary:
                    type: object
                    properties:
                      LOW:
                        type: integer
                      MEDIUM:
                        type: integer
                      HIGH:
                        type: integer
                      CRITICAL:
                        type: integer
                  topBottlenecks:
                    type: array
                    items:
                      type: object
                      properties:
                        code:
                          type: string
                        count:
                          type: integer
                  lastUpdated:
                    type: string

  /bottleneck/summary:
    get:
      summary: Get bottleneck analysis
      operationId: getBottleneckSummary
      description: |
        Returns detailed bottleneck analysis including:
        - Bottleneck counts by code
        - Detailed shipment lists per bottleneck
        - Aging distribution (24h, 48h, 72h buckets)
        - Risk levels
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  bottlenecks:
                    type: object
                  details:
                    type: object
                  agingDistribution:
                    type: object
                    properties:
                      under_24h:
                        type: integer
                      24h_to_48h:
                        type: integer
                      48h_to_72h:
                        type: integer
                      over_72h:
                        type: integer
                  lastUpdated:
                    type: string

  /ingest/events:
    post:
      summary: Ingest events (idempotent)
      operationId: ingestEvents
      description: |
        Ingest events with idempotent upsert.

        Features:
        - Deduplication by eventKey
        - Batch processing (≤10 records/req)
        - Rate-limited (5 rps)

        Note: This endpoint is designed for automated systems (RPA, ETL).
        Manual testing requires valid Airtable field names.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - events
              properties:
                batchId:
                  type: string
                  description: Unique batch identifier
                  example: "2025-12-25_EDAS_0600"
                sourceSystem:
                  type: string
                  description: Source system identifier
                  example: "RPA"
                timezone:
                  type: string
                  description: Timezone of the source data
                  example: "Asia/Dubai"
                events:
                  type: array
                  description: Array of events to ingest
                  items:
                    type: object
                    description: Event record (fields must match Airtable schema)
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  batchId:
                    type: string
                  sourceSystem:
                    type: string
                  ingested:
                    type: integer
                    description: Number of events ingested
                  batches:
                    type: integer
                    description: Number of API batches processed
                  timestamp:
                    type: string
        '400':
          description: Bad request (no events provided)
        '500':
          description: Server error
        '503':
          description: Airtable not configured

# No authentication required - API is public
