openapi: 3.1.0
info:
  title: Airtable Direct API for GETS Logistics
  version: 1.0.3
  description: |
    Direct Airtable access for HVDC Project Logistics.
    Base: appnLz06h07aMm366
    Requires Bearer authentication (Airtable PAT).

    **Protected Fields** (warn before updating):
    - Shipments: shptNo, currentBottleneckCode, bottleneckSince, riskLevel, nextAction, actionOwner, dueAt
    - Documents: shptNo, docType, status
    - Actions: shptNo, status, priority, dueAt, actionText, owner
    - Events: timestamp, shptNo, entityType, toStatus

servers:
  - url: https://api.airtable.com/v0
    description: Airtable API v0

paths:
  /{baseId}/{tableName}:
    get:
      summary: Get records from Airtable table
      operationId: getRecords
      description: |
        Query table with filtering, sorting, and pagination (max 100).
        Tables: Shipments, Documents, Approvals, Actions, Events, Evidence, BottleneckCodes,
        Owners, Vendors, Sites. filterByFormula examples: {shptNo}='SCT-0143';
        AND({riskLevel}='HIGH',IS_BEFORE({dueAt},'2025-12-30')).
      parameters:
        - name: baseId
          in: path
          required: true
          description: Airtable Base ID (use appnLz06h07aMm366)
          schema:
            type: string
          example: appnLz06h07aMm366

        - name: tableName
          in: path
          required: true
          description: Table name (Shipments, Documents, Approvals, Actions, Events, etc.)
          schema:
            type: string
          example: Shipments

        - name: maxRecords
          in: query
          description: Max records to return (default 100, max 100)
          schema:
            type: integer
            maximum: 100
          example: 10

        - name: pageSize
          in: query
          description: Records per page (max 100)
          schema:
            type: integer
            maximum: 100

        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: string

        - name: view
          in: query
          description: View name or ID
          schema:
            type: string

        - name: sortField
          in: query
          description: Sort field name (use with sortDirection)
          schema:
            type: string
          example: shptNo

        - name: sortDirection
          in: query
          description: Sort direction (use with sortField)
          schema:
            type: string
            enum: [asc, desc]
          example: asc

        - name: filterByFormula
          in: query
          description: Airtable formula (e.g. {shptNo}='SCT-0143', AND({riskLevel}='HIGH', IS_BEFORE({dueAt}, '2025-12-30')))
          schema:
            type: string
          example: "{shptNo}='SCT-0143'"

        - name: fields
          in: query
          description: Specific fields to return (comma-separated or repeated)
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: [shptNo, status, riskLevel]

      security:
        - BearerAuth: []

      responses:
        '200':
          description: List of records
          content:
            application/json:
              schema:
                type: object
                properties:
                  records:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        createdTime:
                          type: string
                        fields:
                          type: object
                  offset:
                    type: string
        '401':
          description: Unauthorized
        '404':
          description: Not found

  /{baseId}/{tableName}/{recordId}:
    get:
      summary: Get single record
      operationId: getRecord
      description: Retrieve one record by ID
      parameters:
        - name: baseId
          in: path
          required: true
          schema:
            type: string
          example: appnLz06h07aMm366
        - name: tableName
          in: path
          required: true
          schema:
            type: string
          example: Shipments
        - name: recordId
          in: path
          required: true
          description: Record ID (recXXXXXXX)
          schema:
            type: string
          example: recABC123XYZ
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Record details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  createdTime:
                    type: string
                  fields:
                    type: object
        '404':
          description: Record not found

    patch:
      summary: Update Airtable record
      operationId: updateRecord
      description: |
        Direct record update. Body must be {"fields":{...}} (no top-level fields).
        Protected fields require confirmation (see info Protected Fields).
        Workflow: find recordId by shptNo, show values, confirm, update, verify via GETS API.
      parameters:
        - name: baseId
          in: path
          required: true
          schema:
            type: string
          example: appnLz06h07aMm366

        - name: tableName
          in: path
          required: true
          schema:
            type: string
          example: Actions

        - name: recordId
          in: path
          required: true
          description: Record ID from getRecords (e.g., recABC123XYZ)
          schema:
            type: string
          example: recABC123XYZ

      requestBody:
        required: true
        description: |
          REQUIRED STRUCTURE: Must wrap all field updates in a "fields" object.

          Correct Format: JSON object with "fields" property containing field updates.
          Example: {"fields": {"actionText": "Share GP copy to DSV.", "status": "OPEN"}}

          Wrong Format: Fields as top-level properties (will cause UnrecognizedKwargsError).
          Example: {"actionText": "Share GP copy to DSV.", "status": "OPEN"}
        content:
          application/json:
            schema:
              type: object
              required:
                - fields
              properties:
                fields:
                  type: object
                  description: |
                    Fields to update. Each key is a field name, value is the new value.
                    Only include fields you want to change.
                  additionalProperties: true
            examples:
              updateAction:
                summary: Update Action record
                description: "Update actionText and status fields (CRITICAL: fields wrapper required)"
                value:
                  fields:
                    actionText: "Share GP copy to DSV."
                    status: "OPEN"
              clearBottleneck:
                summary: Clear bottleneck in Shipments
                description: Clear bottleneck code and set risk level
                value:
                  fields:
                    currentBottleneckCode: "CLEARED"
                    riskLevel: "LOW"
              updateDueDate:
                summary: Update due date
                description: Update dueAt field with ISO datetime
                value:
                  fields:
                    dueAt: "2025-12-30T12:00:00+04:00"
              updateMultipleFields:
                summary: Update multiple fields
                description: Update actionText, status, and owner together
                value:
                  fields:
                    actionText: "Confirm DSV port POC"
                    status: "IN_PROGRESS"
                    owner: "John Doe"
                    dueAt: "2025-12-31T17:00:00+04:00"

      security:
        - BearerAuth: []

      responses:
        '200':
          description: Updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  createdTime:
                    type: string
                  fields:
                    type: object
              example:
                id: recABC123XYZ
                createdTime: "2025-12-24T10:00:00.000Z"
                fields:
                  actionText: "Share GP copy to DSV."
                  status: "OPEN"
        '401':
          description: Unauthorized (check PAT token)
        '404':
          description: Record not found (verify recordId and tableName)
        '422':
          description: Invalid field names or values (check field names against Airtable schema)

components:
  schemas: {}
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        Airtable Personal Access Token.

        Get from https://airtable.com/create/tokens with:
        - Scopes: data.records:read, data.records:write
        - Access: base appnLz06h07aMm366

        In ChatGPT Actions:
        - Authentication Type: Bearer
        - Token: paste your PAT (starts with "pat...")
