openapi: 3.1.0
info:
  title: GETS Logistics API
  version: 1.8.0
  description: |
    HVDC Project Logistics API (Phase 4.1 - Complete)

    Provides operational status packets for shipment document tracking,
    approval management, bottleneck analysis, and KPI monitoring.

    **New in v1.8.0**:
    - Approval summary endpoint with D-5/D-15 SLA classification
    - Bottleneck analysis with aging distribution
    - Document event history tracking
    - rename-safe fieldId parsing
    - Z/UTC timezone support

    **Features**:
    - Offset paging (automatic pagination)
    - Rate limiting (5 rps per base)
    - Retry logic (429, 503)
    - Batch operations (â‰¤10 records/req)
    - Upsert support (idempotent ingest)

    **Data Source**: Airtable (Real-time)
    **Timezone**: Asia/Dubai (+04:00)
    **Schema Version**: 2025-12-25T00:32:52+0400

  x-airtable-baseId: appnLz06h07aMm366
  x-airtable-schemaVersion: 2025-12-25T00:32:52+0400
  x-protected-fields:
    Shipments:
      - shptNo
      - currentBottleneckCode
      - bottleneckSince
      - riskLevel
      - nextAction
      - actionOwner
      - dueAt
    Documents:
      - shptNo
      - docType
      - status
    Actions:
      - shptNo
      - status
      - priority
      - dueAt
      - actionText
      - owner
    Events:
      - timestamp
      - shptNo
      - entityType
      - toStatus

servers:
  - url: https://gets-logistics-api.vercel.app
    description: Production server (Vercel)

paths:
  /:
    get:
      summary: API information
      operationId: getApiInfo
      description: Returns API version, available endpoints, and system status.
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                  version:
                    type: string
                  endpoints:
                    type: array
                    items:
                      type: string

  /health:
    get:
      summary: Health check
      operationId: getHealth
      description: Returns API health status, configuration, and schema validation info.
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  airtable:
                    type: object
                  schema:
                    type: object
                  version:
                    type: string

  /document/status/{shptNo}:
    get:
      summary: Get document status packet
      operationId: getDocumentStatus
      description: Operational status for BOE, DO, COO, HBL, CIPL with bottleneck, action, evidence.
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number (e.g., SCT-0143)
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Document status packet
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  doc:
                    type: object
                    properties:
                      boeStatus:
                        type: string
                      doStatus:
                        type: string
                      cooStatus:
                        type: string
                      hblStatus:
                        type: string
                      ciplStatus:
                        type: string
                  bottleneck:
                    type: object
                    properties:
                      code:
                        type: string
                      since:
                        type: string
                      riskLevel:
                        type: string
                  action:
                    type: object
                    properties:
                      nextAction:
                        type: string
                      owner:
                        type: string
                      dueAt:
                        type: string
                  evidence:
                    type: array
                    items:
                      type: object
                  meta:
                    type: object
                    properties:
                      dataLagMinutes:
                        type: integer
                      lastUpdated:
                        type: string
        '404':
          description: Shipment not found
        '503':
          description: Service unavailable

  /approval/status/{shptNo}:
    get:
      summary: Get approval status for shipment
      operationId: getApprovalStatus
      description: Approval details with D-5/D-15 SLA, priority (OVERDUE/CRITICAL/HIGH/NORMAL).
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number (e.g., SCT-0143)
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Approval status (empty array if no approvals)
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  approvals:
                    type: array
                    items:
                      type: object
                      properties:
                        approvalKey:
                          type: string
                        approvalType:
                          type: string
                        status:
                          type: string
                        submittedAt:
                          type: string
                        dueAt:
                          type: string
                        daysUntilDue:
                          type: number
                        priority:
                          type: string
                        owner:
                          type: string
                        evidenceIds:
                          type: array
                          items:
                            type: string
                  summary:
                    type: object
                    properties:
                      total:
                        type: integer
                      pending:
                        type: integer
                      approved:
                        type: integer
                      critical:
                        type: integer
                      overdue:
                        type: integer
                  lastUpdated:
                    type: string
        '404':
          description: Shipment not found (shipment does not exist in Airtable)
        '503':
          description: Service unavailable

  /approval/summary:
    get:
      summary: Get global approval summary
      operationId: getApprovalSummary
      description: All approvals stats by type, status, D-15/D-5/overdue buckets.
      responses:
        '200':
          description: Global approval summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: object
                    properties:
                      total:
                        type: integer
                      pending:
                        type: integer
                      approved:
                        type: integer
                      rejected:
                        type: integer
                  byType:
                    type: object
                    description: Approval counts by type (FANR, MOEI, etc.)
                  byStatus:
                    type: object
                    description: Approval counts by status
                  critical:
                    type: object
                    properties:
                      overdue:
                        type: integer
                      d5:
                        type: integer
                      d15:
                        type: integer
                  lastUpdated:
                    type: string
        '503':
          description: Service unavailable

  /document/events/{shptNo}:
    get:
      summary: Get event history for shipment
      operationId: getDocumentEvents
      description: Chronological event ledger (latest first) for audit trail.
      parameters:
        - name: shptNo
          in: path
          required: true
          description: Shipment number (e.g., SCT-0143)
          schema:
            type: string
          example: SCT-0143
      responses:
        '200':
          description: Event history (may be empty array)
          content:
            application/json:
              schema:
                type: object
                properties:
                  shptNo:
                    type: string
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        eventId:
                          type: integer
                        timestamp:
                          type: string
                        entityType:
                          type: string
                        fromStatus:
                          type: string
                        toStatus:
                          type: string
                        bottleneckCode:
                          type: string
                        actor:
                          type: string
                        sourceSystem:
                          type: string
                  total:
                    type: integer
                  lastUpdated:
                    type: string
        '404':
          description: Shipment not found
        '503':
          description: Service unavailable

  /status/summary:
    get:
      summary: Get overall KPI summary
      operationId: getStatusSummary
      description: KPI metrics - shipment count, doc rates, risk distribution, top bottlenecks.
      responses:
        '200':
          description: KPI summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataSource:
                    type: string
                  totalShipments:
                    type: integer
                  boeRate:
                    type: number
                  doRate:
                    type: number
                  cooRate:
                    type: number
                  hblRate:
                    type: number
                  ciplRate:
                    type: number
                  riskSummary:
                    type: object
                    properties:
                      LOW:
                        type: integer
                      MEDIUM:
                        type: integer
                      HIGH:
                        type: integer
                      CRITICAL:
                        type: integer
                  topBottlenecks:
                    type: array
                    items:
                      type: object
                      properties:
                        code:
                          type: string
                        count:
                          type: integer
                  lastUpdated:
                    type: string
        '503':
          description: Service unavailable

  /bottleneck/summary:
    get:
      summary: Get bottleneck analysis
      operationId: getBottleneckSummary
      description: Bottleneck stats by code/category with aging (24h/48h/72h+) and shipment lists.
      responses:
        '200':
          description: Bottleneck analysis
          content:
            application/json:
              schema:
                type: object
                properties:
                  byCategory:
                    type: object
                    description: Counts by bottleneck category
                  byCode:
                    type: object
                    description: Detailed stats per bottleneck code
                  aging:
                    type: object
                    properties:
                      under24h:
                        type: integer
                      h24to48:
                        type: integer
                      h48to72:
                        type: integer
                      over72h:
                        type: integer
                  topBottlenecks:
                    type: array
                    items:
                      type: object
                      properties:
                        code:
                          type: string
                        count:
                          type: integer
                        riskLevel:
                          type: string
                        shipments:
                          type: array
                          items:
                            type: string
                  totalActive:
                    type: integer
                  lastUpdated:
                    type: string
        '503':
          description: Service unavailable

  /ingest/events:
    post:
      summary: Ingest events (idempotent)
      operationId: ingestEvents
      description: Batch event ingestion with deduplication and rate-limiting. For RPA/ETL systems.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - events
              properties:
                batchId:
                  type: string
                  description: Unique batch identifier
                  example: "2025-12-25_EDAS_0600"
                sourceSystem:
                  type: string
                  description: Source system identifier
                  example: "RPA"
                timezone:
                  type: string
                  description: Timezone of the source data
                  example: "Asia/Dubai"
                events:
                  type: array
                  description: Array of events (fields must match Airtable schema)
                  items:
                    type: object
      responses:
        '200':
          description: Events ingested successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  batchId:
                    type: string
                  sourceSystem:
                    type: string
                  ingested:
                    type: integer
                  batches:
                    type: integer
                  timestamp:
                    type: string
        '400':
          description: Bad request (no events)
        '500':
          description: Server error
        '503':
          description: Airtable not configured

# No authentication required - API is public for internal use
